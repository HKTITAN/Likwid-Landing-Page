<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Editor - Likwid AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Editor.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.29.1/dist/editorjs.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.8.1/dist/header.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.4/dist/paragraph.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.9.0/dist/list.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@1.6.0/dist/checklist.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.6.0/dist/quote.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@1.4.0/dist/marker.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@2.9.0/dist/code.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@1.4.0/dist/delimiter.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@1.5.0/dist/inline-code.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/link@2.6.2/dist/link.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@2.7.0/dist/embed.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@2.3.0/dist/table.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@1.4.0/dist/warning.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@2.9.0/dist/image.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@2.5.0/dist/raw.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@1.6.0/dist/simple-image.umd.js"></script>
    
    <script src="config-manager.js"></script>
    <script src="api-key-manager.js"></script>
    <script src="blog-manager.js"></script>
    <script src="ai-service.js"></script>
    <script src="post-storage.js"></script>
    
    <style>
        :root {
            /* Notion-inspired color palette */
            --notion-bg: #ffffff;
            --notion-bg-secondary: #fafafa;
            --notion-bg-tertiary: #f7f6f3;
            --notion-text: #37352f;
            --notion-text-light: #6f6f6f;
            --notion-text-lighter: #9b9a97;
            --notion-border: #e9e9e7;
            --notion-border-light: #f1f1ef;
            --notion-hover: #f7f6f3;
            --notion-blue: #2383e2;
            --notion-purple: #9065b0;
            --notion-pink: #e255a1;
            --notion-orange: #d9730d;
            --notion-green: #448361;
            --notion-yellow: #c99221;
            --notion-red: #e03e3e;
            
            /* Likwid brand colors */
            --primary-color: #7E44EE;
            --secondary-color: #0059FC;
            --accent-color: #FFD700;
            
            /* Enhanced shadows for depth */
            --shadow-subtle: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-strong: 0 8px 32px rgba(0, 0, 0, 0.12);
            
            /* Smooth transitions */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-medium: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Cursor Implementation */
        * {
            cursor: url('../assets/arrowhead-rounded-outline.svg') 12 12, auto;
        }

        *:hover {
            cursor: url('../assets/arrowhead-rounded-outline.svg') 16 16, auto;
        }

        button, a, input, textarea, select, .clickable {
            cursor: url('../assets/arrowhead-rounded-outline.svg') 14 14, pointer !important;
            transition: transform 0.2s ease;
        }

        button:hover, a:hover, .clickable:hover {
            cursor: url('../assets/arrowhead-rounded-outline.svg') 18 18, pointer !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--notion-bg);
            color: var(--notion-text);
            line-height: 1.5;
            font-size: 16px;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        /* Top Navigation Bar */
        .top-nav {
            height: 60px;
            background: var(--notion-bg);
            border-bottom: 1px solid var(--notion-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            position: relative;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--notion-text-light);
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: var(--notion-hover);
            color: var(--notion-text);
        }

        .nav-btn.primary {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }

        .nav-btn.primary:hover {
            background: #6d3bcc;
        }

        .back-btn {
            text-decoration: none;
            color: var(--notion-text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .back-btn:hover {
            background: var(--notion-hover);
            color: var(--notion-text);
        }

        /* Main Layout */
        .editor-layout {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Main Editor Area */
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .editor-container {
            flex: 1;
            padding: 2rem 6rem;
            overflow-y: auto;
            background: var(--notion-bg);
        }

        /* Page Title Area */
        .page-title-area {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
            color: var(--notion-text);
            padding: 0;
            margin-bottom: 0.5rem;
            resize: none;
            overflow: hidden;
        }

        .page-title::placeholder {
            color: var(--notion-text-lighter);
        }

        .page-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--notion-text-light);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }

        .page-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* EditorJS Container */
        #editorjs {
            min-height: 400px;
            font-family: inherit;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 320px;
            background: var(--notion-bg-secondary);
            border-left: 1px solid var(--notion-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--notion-border);
            font-weight: 600;
            color: var(--notion-text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* Sidebar Sections */
        .sidebar-section {
            border-bottom: 1px solid var(--notion-border-light);
        }

        .sidebar-section-header {
            padding: 0.75rem 1rem;
            background: var(--notion-bg-tertiary);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--notion-text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-section-content {
            padding: 1rem;
        }

        /* Form Fields */
        .field-group {
            margin-bottom: 1rem;
        }

        .field-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--notion-text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--notion-border);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--notion-text);
            background: var(--notion-bg);
            transition: all var(--transition-fast);
        }

        .field-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(126, 68, 238, 0.1);
        }

        .field-textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .field-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2rem;
        }

        /* Character Counter */
        .char-counter {
            font-size: 0.75rem;
            color: var(--notion-text-lighter);
            text-align: right;
            margin-top: 0.25rem;
        }

        .char-counter.over-limit {
            color: var(--notion-red);
        }

        /* Checkbox */
        .checkbox-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-input {
            width: auto;
        }

        /* Analytics Cards */
        .analytics-card {
            background: var(--notion-bg);
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .analytics-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .analytics-label {
            font-size: 0.75rem;
            color: var(--notion-text-light);
            font-weight: 500;
        }

        .analytics-description {
            font-size: 0.625rem;
            color: var(--notion-text-lighter);
            margin-top: 0.25rem;
        }

        /* SEO Score Circle */
        .seo-score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0 auto 0.5rem auto;
        }

        .score-excellent {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .score-good {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .score-poor {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* AI Generate Button */
        .ai-generate-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .ai-generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .ai-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* AI Progress Indicator */
        .ai-progress {
            width: 100%;
            height: 4px;
            background: var(--notion-border);
            border-radius: 2px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .ai-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .ai-progress-text {
            font-size: 0.75rem;
            color: var(--notion-text-light);
            text-align: center;
            margin-top: 0.25rem;
        }

        /* AI Insights Modal */
        .ai-insights-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .ai-insights-content {
            background: var(--notion-bg);
            border-radius: 12px;
            max-width: 600px;
            width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideInUp 0.3s ease;
        }

        .ai-insights-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--notion-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ai-insights-header h3 {
            margin: 0;
            color: var(--notion-text);
            font-size: 1.25rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--notion-text-light);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--notion-hover);
            color: var(--notion-text);
        }

        .ai-insights-body {
            padding: 1.5rem;
        }

        .insight-section {
            margin-bottom: 1.5rem;
        }

        .insight-section h4 {
            margin: 0 0 0.75rem 0;
            color: var(--notion-text);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--notion-bg-secondary);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .insight-item strong {
            color: var(--notion-text);
            margin-right: 0.5rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .feature-tag {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        .ai-insights-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--notion-border);
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .btn-primary, .btn-secondary {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--notion-border);
            color: var(--notion-text);
        }

        .btn-secondary:hover {
            background: var(--notion-hover);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* AI Content Generation Section */
        .ai-generation-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            color: white;
            animation: slideInUp 0.5s ease;
        }

        .ai-generation-header h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .ai-generation-header p {
            margin: 0 0 1.5rem 0;
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.5;
        }

        .ai-generation-input textarea {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.95);
            color: var(--notion-text);
            resize: vertical;
            min-height: 80px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .ai-generation-input textarea:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .ai-generation-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ai-generate-complete-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .ai-generate-complete-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .ai-generation-close {
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-generation-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .ai-generation-examples p {
            margin: 0 0 0.75rem 0;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .example-topics {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .example-topic {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .example-topic:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .ai-status {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: none;
        }

        .ai-status.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Image Management Styles */
        .image-management-section {
            margin-top: 0.5rem;
        }

        .current-image-display {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            background: var(--notion-bg-secondary);
        }

        .image-input-section {
            margin-bottom: 1rem;
        }

        .image-options {
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            overflow: hidden;
        }

        .image-option-tabs {
            display: flex;
            background: var(--notion-bg-secondary);
            border-bottom: 1px solid var(--notion-border);
        }

        .image-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--notion-text-light);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .image-tab:hover {
            background: var(--notion-hover);
        }

        .image-tab.active {
            background: var(--notion-bg);
            color: var(--notion-text);
            font-weight: 500;
        }

        .image-tab-content {
            padding: 1rem;
        }

        .file-upload-area {
            border: 2px dashed var(--notion-border);
            border-radius: 6px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--notion-blue);
            background: var(--notion-bg-secondary);
        }

        .file-upload-area.drag-over {
            border-color: var(--notion-blue);
            background: var(--notion-bg-secondary);
        }

        .upload-content i {
            font-size: 2rem;
            color: var(--notion-text-lighter);
            margin-bottom: 0.5rem;
        }

        .upload-content p {
            margin: 0;
            color: var(--notion-text-light);
        }

        .image-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--notion-border);
            border-radius: 4px;
            background: var(--notion-bg);
            color: var(--notion-text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: var(--notion-hover);
        }

        .action-btn.primary-btn {
            background: var(--notion-blue);
            color: white;
            border-color: var(--notion-blue);
        }

        .action-btn.primary-btn:hover {
            background: #1a6ec2;
        }

        .action-btn.secondary-btn {
            background: var(--notion-purple);
            color: white;
            border-color: var(--notion-purple);
        }

        .action-btn.secondary-btn:hover {
            background: #7a5494;
        }

        .action-btn.remove-btn {
            background: var(--notion-red);
            color: white;
            border-color: var(--notion-red);
        }

        .action-btn.remove-btn:hover {
            background: #c23333;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .image-loading {
            text-align: center;
            padding: 2rem 1rem;
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            background: var(--notion-bg-secondary);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--notion-border);
            border-top: 3px solid var(--notion-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin: 0;
            color: var(--notion-text-light);
            font-size: 0.875rem;
        }

        .image-result {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            background: var(--notion-bg-secondary);
        }

        .image-description {
            margin: 0.5rem 0 1rem;
            padding: 0.75rem;
            background: var(--notion-bg);
            border-radius: 4px;
            font-size: 0.875rem;
            color: var(--notion-text-light);
            border: 1px solid var(--notion-border-light);
        }

        /* Notion-like Editor Styles */
        .codex-editor__redactor {
            padding: 0 !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
        }

        .ce-block__content {
            max-width: none !important;
            margin: 0 !important;
        }

        .ce-toolbar__content {
            max-width: none !important;
        }

        .ce-paragraph {
            font-size: 16px !important;
            line-height: 1.6 !important;
            margin: 0.5rem 0 !important;
        }

        .ce-header {
            font-weight: 700 !important;
            margin: 1.5rem 0 0.75rem 0 !important;
            line-height: 1.3 !important;
        }

        .ce-header[data-level="1"] {
            font-size: 2.25rem !important;
        }

        .ce-header[data-level="2"] {
            font-size: 1.875rem !important;
        }

        .ce-header[data-level="3"] {
            font-size: 1.5rem !important;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .right-sidebar {
                width: 280px;
            }
            
            .editor-container {
                padding: 2rem 4rem;
            }
        }

        /* Cover Image Section (Notion-style) */
        .cover-image-section {
            margin-bottom: 2rem;
            position: relative;
        }

        .cover-image-container {
            position: relative;
            width: 100%;
            height: 280px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cover-image-container:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #cover-image-display {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
        }

        .cover-image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f7f7f7, #e8e8e8);
            border: 2px dashed #d0d0d0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .cover-image-placeholder:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #f0f0ff, #e8e8ff);
        }

        .cover-placeholder-content {
            text-align: center;
            color: #888;
        }

        .cover-placeholder-content i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .cover-placeholder-content span {
            font-size: 1rem;
            font-weight: 500;
        }

        .cover-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .cover-image-container:hover .cover-image-overlay {
            opacity: 1;
        }

        .cover-image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cover-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            color: var(--notion-text);
        }

        .cover-btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .cover-btn.danger {
            color: var(--notion-red);
        }

        .cover-btn.danger:hover {
            background: var(--notion-red);
            color: white;
        }

        /* Cover image generation loading state */
        .cover-image-generating {
            position: relative;
        }

        .cover-image-generating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .cover-image-generating::before {
            content: 'Generating cover image...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            font-weight: 500;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .right-sidebar {
                display: none;
            }
            
            .editor-container {
                padding: 2rem 2rem;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--notion-bg);
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--notion-text-light);
            box-shadow: var(--shadow-medium);
            opacity: 0;
            transition: opacity var(--transition-fast);
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .auto-save-indicator.saving {
            color: var(--primary-color);
        }

        .auto-save-indicator.saved {
            color: var(--notion-green);
        }

        /* AI Features */
        .seo-factors {
            font-size: 0.75rem;
        }

        .seo-factor {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
        }

        .seo-factor.good {
            color: var(--notion-green);
        }

        .seo-factor.warning {
            color: var(--notion-orange);
        }

        .seo-factor.error {
            color: var(--notion-red);
        }

        /* Keyword Tags */
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .keyword-tag {
            background: var(--notion-bg-tertiary);
            border: 1px solid var(--notion-border);
            border-radius: 12px;
            padding: 0.2rem 0.5rem;
            font-size: 0.625rem;
            color: var(--notion-text-light);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .keyword-tag:hover {
            background: var(--notion-hover);
            color: var(--notion-text);
            transform: translateY(-1px);
        }

        .keyword-tag.used {
            background: var(--notion-green);
            color: white;
            border-color: var(--notion-green);
        }

        .keyword-tag.suggested {
            background: var(--notion-blue);
            color: white;
            border-color: var(--notion-blue);
        }

        .keyword-tag.clickable:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .keyword-tag:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
        }

        .keyword-tag.selected {
            background: var(--notion-green);
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            font-size: 0.875rem;
        }

        .ai-thinking i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .improvement-suggestion {
            background: var(--notion-bg-tertiary);
            border-left: 3px solid var(--primary-color);
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 0 4px 4px 0;
            font-size: 0.875rem;
        }

        .improvement-suggestion .priority-high {
            border-left-color: var(--notion-red);
        }

        .improvement-suggestion .priority-medium {
            border-left-color: var(--notion-orange);
        }

        .improvement-suggestion .priority-low {
            border-left-color: var(--notion-green);
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-left">
            <a href="blog-dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
            <div style="color: var(--notion-text-lighter); font-size: 0.875rem;" id="document-status">
                Draft • Auto-saved
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="previewPost()">
                <i class="fas fa-eye"></i>
                Preview
            </button>
            <button class="nav-btn" onclick="savePost('draft')">
                <i class="fas fa-save"></i>
                Save Draft
            </button>
            <button class="nav-btn primary" onclick="publishPost()">
                <i class="fas fa-paper-plane"></i>
                Publish
            </button>
        </div>
    </div>

    <!-- Main Editor Layout -->
    <div class="editor-layout">
        <!-- Main Editor Area -->
        <div class="editor-main">
            <div class="editor-container">
                <!-- AI Content Generation Section -->
                <div class="ai-generation-section" id="ai-generation-section" style="display: none;">
                    <div class="ai-generation-header">
                        <h2>🚀 What would you like to write about today?</h2>
                        <p>Describe your topic and I'll generate a complete blog post with keywords, SEO optimization, and a featured image.</p>
                    </div>
                    <div class="ai-generation-input">
                        <textarea 
                            id="topic-input" 
                            placeholder="e.g., 'AI automation in manufacturing', 'ERP implementation challenges', 'inventory management best practices'..."
                            rows="3"
                        ></textarea>
                        <div class="ai-generation-actions">
                            <button class="ai-generate-complete-btn" onclick="generateCompleteContent()">
                                <i class="fas fa-magic"></i>
                                Generate Complete Content
                            </button>
                            <button class="ai-generation-close" onclick="hideAIGeneration()">
                                <i class="fas fa-times"></i>
                                Start Writing Manually
                            </button>
                        </div>
                    </div>
                    <div class="ai-generation-examples">
                        <p><strong>Example topics:</strong></p>
                        <div class="example-topics">
                            <span class="example-topic" onclick="setTopicAndGenerate('Smart factory automation benefits')">Smart factory automation benefits</span>
                            <span class="example-topic" onclick="setTopicAndGenerate('ERP system ROI calculation')">ERP system ROI calculation</span>
                            <span class="example-topic" onclick="setTopicAndGenerate('Predictive maintenance implementation')">Predictive maintenance implementation</span>
                            <span class="example-topic" onclick="setTopicAndGenerate('Supply chain optimization strategies')">Supply chain optimization strategies</span>
                        </div>
                    </div>
                    <div id="ai-status" class="ai-status"></div>
                </div>

                <!-- Cover Image Section (Notion-style) -->
                <div class="cover-image-section" id="cover-image-section">
                    <div class="cover-image-container" id="cover-image-container">
                        <img id="cover-image-display" src="" alt="Cover image" style="display: none;">
                        <div class="cover-image-placeholder" id="cover-image-placeholder">
                            <div class="cover-placeholder-content">
                                <i class="fas fa-image"></i>
                                <span>Add cover image</span>
                            </div>
                        </div>
                        <div class="cover-image-overlay" id="cover-image-overlay" style="display: none;">
                            <div class="cover-image-actions">
                                <button class="cover-btn" onclick="generateCoverImage()" title="Generate AI Cover">
                                    <i class="fas fa-magic"></i>
                                    Generate
                                </button>
                                <button class="cover-btn" onclick="regenerateCoverImage()" title="Regenerate Cover">
                                    <i class="fas fa-sync-alt"></i>
                                    Regenerate
                                </button>
                                <button class="cover-btn" onclick="uploadCoverImage()" title="Upload Image">
                                    <i class="fas fa-upload"></i>
                                    Upload
                                </button>
                                <button class="cover-btn danger" onclick="removeCoverImage()" title="Remove Cover">
                                    <i class="fas fa-trash"></i>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page Title Area -->
                <div class="page-title-area">
                    <textarea class="page-title" id="post-title" placeholder="Untitled"></textarea>
                    <div class="page-meta">
                        <div class="page-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="last-edited">Last edited 2 minutes ago</span>
                        </div>
                        <div class="page-meta-item">
                            <i class="fas fa-user"></i>
                            <span id="author-display">Author</span>
                        </div>
                        <div class="page-meta-item">
                            <i class="fas fa-eye"></i>
                            <span id="word-count">0 words</span>
                        </div>
                    </div>
                </div>

                <!-- Editor.js Container -->
                <div id="editorjs"></div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cog"></i>
                Post Settings
            </div>
            
            <div class="sidebar-content">
                <!-- Analytics Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <span>Live Analytics</span>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="sidebar-section-content">
                        <div class="analytics-card">
                            <div class="seo-score-circle score-poor" id="seo-score-circle">0</div>
                            <div class="analytics-label">SEO Score</div>
                            <div class="analytics-description">Based on content analysis</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--primary-color);" id="live-word-count">0</div>
                                <div class="analytics-label">Words</div>
                                <div class="analytics-description">Target: 800+</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--notion-green);" id="live-readability">0</div>
                                <div class="analytics-label">Reading Ease</div>
                                <div class="analytics-description">Flesch score</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--notion-orange);" id="csv-keywords-count">0</div>
                                <div class="analytics-label">CSV Keywords</div>
                                <div class="analytics-description">From strategy list</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--notion-purple);" id="keyword-density">0%</div>
                                <div class="analytics-label">Keyword Density</div>
                                <div class="analytics-description">Target: 1-3%</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--notion-blue);" id="keyword-coverage">0%</div>
                                <div class="analytics-label">Keyword Coverage</div>
                                <div class="analytics-description">CSV utilization</div>
                            </div>
                            
                            <div class="analytics-card">
                                <div class="analytics-number" style="color: var(--notion-green);" id="used-keywords-count">0</div>
                                <div class="analytics-label">Used Keywords</div>
                                <div class="analytics-description">Unique CSV terms</div>
                            </div>
                        </div>

                        <!-- SEO Factors List -->
                        <div class="seo-factors" id="seo-factors" style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--notion-text-light); margin-bottom: 0.5rem;">SEO FACTORS</div>
                            <div id="seo-factors-list" style="font-size: 0.675rem; color: var(--notion-text-lighter);">
                                Analyzing...
                            </div>
                        </div>

                        <!-- Keyword Insights Section -->
                        <div class="seo-factors" style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--notion-text-light); margin-bottom: 0.5rem;">KEYWORD INSIGHTS</div>
                            
                            <!-- Used Keywords Display -->
                            <div style="margin-bottom: 1rem;">
                                <div style="font-size: 0.675rem; color: var(--notion-text-lighter); margin-bottom: 0.375rem;">Currently Used Keywords</div>
                                <div id="used-keywords-display" class="keyword-tags" style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                    <span class="keyword-tag">Loading...</span>
                                </div>
                            </div>

                            <!-- Keyword Suggestions -->
                            <div>
                                <div style="font-size: 0.675rem; color: var(--notion-text-lighter); margin-bottom: 0.375rem;">Suggested Keywords</div>
                                <div id="keyword-suggestions" class="keyword-tags" style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                    <span class="keyword-tag">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <span>Basic Information</span>
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="sidebar-section-content">
                        <div class="field-group">
                            <label class="field-label">Status</label>
                            <select class="field-input field-select" id="post-status">
                                <option value="draft">Draft</option>
                                <option value="published">Published</option>
                            </select>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Category</label>
                            <select class="field-input field-select" id="post-category">
                                <option value="Technology">Technology</option>
                                <option value="Business">Business</option>
                                <option value="Innovation">Innovation</option>
                                <option value="Industry">Industry</option>
                                <option value="Tutorial">Tutorial</option>
                            </select>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Excerpt</label>
                            <textarea class="field-input field-textarea" id="post-excerpt" placeholder="Brief description..."></textarea>
                            <div class="char-counter" id="excerpt-counter">0/160</div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Featured Image</label>
                            <div class="image-management-section">
                                <!-- Current Image Display -->
                                <div class="current-image-display" id="current-image-display" style="display: none;">
                                    <img id="current-image-preview" src="" alt="Current featured image" style="max-width: 100%; height: auto; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <div class="image-actions">
                                        <button type="button" class="action-btn remove-btn" onclick="removeCurrentImage()">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>

                                <!-- Image URL Input -->
                                <div class="image-input-section">
                                    <input type="url" class="field-input" id="featured-image" placeholder="Enter image URL or use options below...">
                                </div>

                                <!-- Image Generation and Upload Options -->
                                <div class="image-options">
                                    <div class="image-option-tabs">
                                        <button type="button" class="image-tab active" onclick="switchImageTab('generate')">
                                            <i class="fas fa-wand-magic-sparkles"></i> Generate
                                        </button>
                                        <button type="button" class="image-tab" onclick="switchImageTab('upload')">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                    </div>

                                    <!-- AI Image Generation -->
                                    <div class="image-tab-content" id="generate-tab">
                                        <div class="field-group">
                                            <textarea class="field-input" id="image-prompt" placeholder="Describe the image you want to generate (e.g., 'A modern smart factory with robotic automation systems')" rows="3"></textarea>
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="action-btn primary-btn" onclick="generateImage()" id="generate-btn">
                                                <i class="fas fa-wand-magic-sparkles"></i> Generate Image
                                            </button>
                                            <button type="button" class="action-btn secondary-btn" onclick="autoGenerateImage()" id="auto-generate-btn">
                                                <i class="fas fa-robot"></i> Auto Generate
                                            </button>
                                        </div>
                                    </div>

                                    <!-- File Upload -->
                                    <div class="image-tab-content" id="upload-tab" style="display: none;">
                                        <div class="file-upload-area" id="file-upload-area">
                                            <div class="upload-content">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                <p>Drop an image here or click to browse</p>
                                                <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                                            </div>
                                        </div>
                                        <div class="image-actions">
                                            <button type="button" class="action-btn primary-btn" onclick="uploadImage()" id="upload-btn" disabled>
                                                <i class="fas fa-upload"></i> Upload & Analyze
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Loading State -->
                                <div class="image-loading" id="image-loading" style="display: none;">
                                    <div class="loading-spinner"></div>
                                    <p class="loading-text">Processing image...</p>
                                </div>

                                <!-- Image Generation Results -->
                                <div class="image-result" id="image-result" style="display: none;">
                                    <img id="generated-image-preview" src="" alt="Generated image" style="max-width: 100%; height: auto; border-radius: 6px; margin-bottom: 0.5rem;">
                                    <div class="image-description" id="image-description"></div>
                                    <div class="image-actions">
                                        <button type="button" class="action-btn primary-btn" onclick="useGeneratedImage()">
                                            <i class="fas fa-check"></i> Use This Image
                                        </button>
                                        <button type="button" class="action-btn secondary-btn" onclick="regenerateImage()">
                                            <i class="fas fa-sync"></i> Regenerate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="field-group">
                            <div class="checkbox-field">
                                <input type="checkbox" class="checkbox-input" id="is-featured">
                                <label class="field-label" style="margin: 0;">Featured Post</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Author Information -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <span>Author</span>
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="sidebar-section-content">
                        <div class="field-group">
                            <label class="field-label">Author Name</label>
                            <input type="text" class="field-input" id="author-name" placeholder="John Doe">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Author Title</label>
                            <input type="text" class="field-input" id="author-title" placeholder="Senior Writer">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Author Avatar (Initials)</label>
                            <input type="text" class="field-input" id="author-avatar" placeholder="JD" maxlength="2">
                        </div>
                    </div>
                </div>

                <!-- SEO Settings -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <span>SEO</span>
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="sidebar-section-content">
                        <div class="field-group">
                            <label class="field-label">URL Slug</label>
                            <input type="text" class="field-input" id="post-slug" placeholder="your-post-url">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Meta Title</label>
                            <input type="text" class="field-input" id="meta-title" placeholder="SEO title">
                            <div class="char-counter" id="meta-title-counter">0/60</div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Meta Description</label>
                            <textarea class="field-input field-textarea" id="meta-description" placeholder="SEO description..."></textarea>
                            <div class="char-counter" id="meta-desc-counter">0/160</div>
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Keywords</label>
                            <input type="text" class="field-input" id="keywords" placeholder="keyword1, keyword2">
                        </div>
                        
                        <div class="field-group">
                            <label class="field-label">Alt Text</label>
                            <input type="text" class="field-input" id="alt-text" placeholder="Image description">
                        </div>

                        <button class="ai-generate-btn" onclick="generateSEOFields()">
                            <i class="fas fa-magic"></i>
                            Generate SEO with AI
                        </button>

                        <button class="ai-generate-btn" onclick="getKeywordSuggestions()" style="margin-top: 0.5rem; background: var(--notion-orange);">
                            <i class="fas fa-lightbulb"></i>
                            Suggest Keywords
                        </button>

                        <button class="ai-generate-btn" onclick="optimizeContent()" style="margin-top: 0.5rem; background: var(--notion-green);">
                            <i class="fas fa-wand-magic-sparkles"></i>
                            AI Content Optimizer
                        </button>
                    </div>
                </div>

                <!-- AI Assistant Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <span>AI Assistant</span>
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="sidebar-section-content">
                        <div class="field-group">
                            <label class="field-label">Ask AI for Help</label>
                            <textarea class="field-input field-textarea" id="ai-query" placeholder="e.g., 'Improve this conclusion' or 'Add more technical details'"></textarea>
                        </div>

                        <button class="ai-generate-btn" onclick="askAI()">
                            <i class="fas fa-comments"></i>
                            Ask AI
                        </button>

                        <div id="ai-response" style="margin-top: 1rem; padding: 0.75rem; background: var(--notion-bg-secondary); border-radius: 4px; font-size: 0.875rem; display: none;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">
                                <i class="fas fa-robot"></i> AI Suggestion:
                            </div>
                            <div id="ai-response-text"></div>
                            <button onclick="applyAISuggestion()" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 3px; font-size: 0.75rem; cursor: pointer;">
                                Apply Suggestion
                            </button>
                        </div>

                        <!-- Content Ideas -->
                        <div style="margin-top: 1rem;">
                            <button class="ai-generate-btn" onclick="getContentIdeas()" style="background: var(--notion-blue);">
                                <i class="fas fa-lightbulb"></i>
                                Content Ideas
                            </button>
                        </div>

                        <!-- AI Improvements -->
                        <div style="margin-top: 1rem;">
                            <button class="ai-generate-btn" onclick="getAIImprovements()" style="background: var(--notion-pink);">
                                <i class="fas fa-chart-line"></i>
                                AI Improvements
                            </button>
                        </div>

                        <!-- Keyword Suggestions Display -->
                        <div id="keyword-suggestions" style="margin-top: 1rem; display: none;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--notion-text-light); margin-bottom: 0.5rem;">SUGGESTED KEYWORDS</div>
                            <div id="keyword-suggestions-list" style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                                <!-- Keywords will be added here -->
                            </div>
                        </div>

                        <!-- AI Improvements Display -->
                        <div id="ai-improvements" style="margin-top: 1rem; display: none;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--notion-text-light); margin-bottom: 0.5rem;">AI SUGGESTIONS</div>
                            <div id="ai-improvements-list">
                                <!-- Improvements will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="auto-save-indicator">
        <i class="fas fa-save"></i>
        <span>Saving...</span>
    </div>

    <script>
        let editor;
        let currentPostId;
        let isNewPost = false;
        let autoSaveInterval;
        let hasUnsavedChanges = false;

        // Initialize editor and load post
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentPostId = urlParams.get('edit') || urlParams.get('id');
            const generateTopic = urlParams.get('generate');
            
            // Check backend server health
            try {
                showAutoSaveIndicator('loading');
                const isBackendHealthy = await window.postStorage.checkServerHealth();
                
                if (!isBackendHealthy) {
                    showNotification('⚠️ Backend server not available. Please start the server with: npm start', 'error');
                    // Continue with limited functionality
                }
            } catch (error) {
                console.error('Backend health check failed:', error);
                showNotification('⚠️ Cannot connect to backend. Some features may not work.', 'warning');
            }
            
            // Initialize editor and wait for it to be ready
            await initializeEditor();
            
            // Initialize cover image functionality
            initializeCoverImageFeatures();
            
            if (currentPostId) {
                await loadPost(currentPostId);
            } else {
                isNewPost = true;
                setupNewPost();
            }
            
            if (generateTopic) {
                generatePostFromTopic(generateTopic);
            }
            
            setupEventListeners();
            startAutoSave();
            checkForNewPost();
        });

        // Initialize Editor.js
        async function initializeEditor() {
            return new Promise((resolve, reject) => {
                try {
                    editor = new EditorJS({
                        holder: 'editorjs',
                        placeholder: 'Start writing your post...',
                        onReady: () => {
                            console.log('Editor.js is ready');
                            resolve();
                        },
                        onChange: () => {
                            hasUnsavedChanges = true;
                            updateDocumentStatus('unsaved');
                        },
                tools: {
                    header: {
                        class: Header,
                        inlineToolbar: ['marker', 'link'],
                        config: {
                            placeholder: 'Enter a header',
                            levels: [1, 2, 3, 4],
                            defaultLevel: 2
                        },
                        shortcut: 'CMD+SHIFT+H'
                    },
                    paragraph: {
                        class: Paragraph,
                        inlineToolbar: true,
                        config: {
                            placeholder: 'Write your content here...',
                            preserveBlank: true
                        }
                    },
                    list: {
                        class: List,
                        inlineToolbar: true,
                        config: {
                            defaultStyle: 'unordered'
                        },
                        shortcut: 'CMD+SHIFT+L'
                    },
                    quote: {
                        class: Quote,
                        inlineToolbar: true,
                        shortcut: 'CMD+SHIFT+O',
                        config: {
                            quotePlaceholder: 'Enter a quote',
                            captionPlaceholder: 'Quote author'
                        }
                    },
                    code: {
                        class: CodeTool,
                        config: {
                            placeholder: 'Enter code...'
                        }
                    },
                    table: {
                        class: Table,
                        inlineToolbar: true,
                        config: {
                            rows: 2,
                            cols: 3,
                            withHeadings: true
                        }
                    },
                    image: {
                        class: SimpleImage,
                        config: {
                            placeholder: 'Paste image URL'
                        }
                    },
                    raw: {
                        class: RawTool,
                        config: {
                            placeholder: 'Enter raw HTML...'
                        }
                    }
                },
                onChange: () => {
                    hasUnsavedChanges = true;
                    updateAnalytics();
                    updateDocumentStatus('unsaved');
                },
                autofocus: true,
            });
                } catch (error) {
                    console.error('Error initializing editor:', error);
                    reject(error);
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Title auto-resize
            const titleElement = document.getElementById('post-title');
            titleElement.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
                hasUnsavedChanges = true;
                updateSlugFromTitle();
                updateAnalytics();
            });

            // Character counters
            setupCharacterCounters();
            
            // Auto-save on form changes
            document.querySelectorAll('.field-input').forEach(input => {
                input.addEventListener('input', () => {
                    hasUnsavedChanges = true;
                    updateDocumentStatus('unsaved');
                });
            });

            // Prevent accidental navigation
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    savePost('draft');
                }
            });
        }

        // Setup character counters
        function setupCharacterCounters() {
            const excerptField = document.getElementById('post-excerpt');
            const excerptCounter = document.getElementById('excerpt-counter');
            
            const metaTitleField = document.getElementById('meta-title');
            const metaTitleCounter = document.getElementById('meta-title-counter');
            
            const metaDescField = document.getElementById('meta-description');
            const metaDescCounter = document.getElementById('meta-desc-counter');

            excerptField.addEventListener('input', function() {
                const length = this.value.length;
                excerptCounter.textContent = `${length}/160`;
                excerptCounter.className = `char-counter ${length > 160 ? 'over-limit' : ''}`;
            });

            metaTitleField.addEventListener('input', function() {
                const length = this.value.length;
                metaTitleCounter.textContent = `${length}/60`;
                metaTitleCounter.className = `char-counter ${length > 60 ? 'over-limit' : ''}`;
            });

            metaDescField.addEventListener('input', function() {
                const length = this.value.length;
                metaDescCounter.textContent = `${length}/160`;
                metaDescCounter.className = `char-counter ${length > 160 ? 'over-limit' : ''}`;
            });
        }

        // Update slug from title
        function updateSlugFromTitle() {
            const title = document.getElementById('post-title').value;
            const slug = title.toLowerCase()
                .replace(/[^a-z0-9 -]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
            document.getElementById('post-slug').value = slug;
        }

        // Load existing post from backend
        // Load post with comprehensive error handling and recovery
        async function loadPost(postId) {
            let loadAttempts = 0;
            const maxAttempts = 3;
            
            while (loadAttempts < maxAttempts) {
                try {
                    console.log(`Loading post from backend (attempt ${loadAttempts + 1}):`, postId);
                    showAutoSaveIndicator('loading');
                    
                    // Initialize PostStorageService if not available
                    if (!window.postStorage) {
                        window.postStorage = new PostStorageService();
                    }
                    
                    const post = await window.postStorage.getPost(postId);
                    
                    if (!post) {
                        throw new Error('Post not found');
                    }

                    console.log('Loaded post data from backend:', post);

                    // Validate editor is ready
                    if (!editor) {
                        throw new Error('Editor is not initialized');
                    }

                    // Load basic fields with error handling
                    try {
                        safeSetValue('post-title', post.title || '');
                        safeSetValue('post-status', post.status || 'draft');
                        safeSetValue('post-category', post.category || 'Technology');
                        safeSetValue('post-excerpt', post.excerpt || '');
                        safeSetValue('featured-image', post.featuredImage || '');
                        safeSetChecked('is-featured', post.is_featured == 1);
                        
                        // Load author fields
                        safeSetValue('author-name', post.author || '');
                        safeSetValue('author-title', post.author_title || '');
                        safeSetValue('author-avatar', post.author_avatar || '');
                        
                        // Load SEO fields
                        safeSetValue('post-slug', post.slug || '');
                        safeSetValue('meta-title', post.meta_title || '');
                        safeSetValue('meta-description', post.meta_description || '');
                        safeSetValue('keywords', post.keywords || '');
                        safeSetValue('alt-text', post.imageAlt || '');
                    } catch (fieldError) {
                        console.warn('Error loading some form fields:', fieldError);
                        // Continue loading even if some fields fail
                    }

                    // Update featured image preview if exists
                    try {
                        if (post.featuredImage) {
                            const preview = document.getElementById('current-image-preview');
                            const display = document.getElementById('current-image-display');
                            if (preview && display) {
                                preview.src = post.featuredImage;
                                display.style.display = 'block';
                            }
                        }
                    } catch (imageError) {
                        console.warn('Error loading featured image preview:', imageError);
                    }

                    // Load cover image if exists
                    try {
                        if (post.coverImage && typeof setCoverImage === 'function') {
                            setCoverImage(post.coverImage);
                        }
                    } catch (coverError) {
                        console.warn('Error loading cover image:', coverError);
                    }

                    // Load content into editor with robust error handling
                    try {
                        if (post.content) {
                            let editorData;
                            if (typeof post.content === 'string') {
                                try {
                                    editorData = JSON.parse(post.content);
                                } catch (parseError) {
                                    console.warn('Content is not valid JSON, treating as plain text');
                                    editorData = {
                                        blocks: [{
                                            type: 'paragraph',
                                            data: { text: post.content }
                                        }]
                                    };
                                }
                            } else {
                                editorData = post.content;
                            }
                            
                            // Validate editor data structure
                            if (!editorData.blocks || !Array.isArray(editorData.blocks)) {
                                editorData = {
                                    blocks: [{
                                        type: 'paragraph',
                                        data: { text: 'Content structure is invalid' }
                                    }]
                                };
                            }
                            
                            await editor.render(editorData);
                        } else {
                            // Load empty content
                            await editor.render({
                                blocks: [{
                                    type: 'paragraph',
                                    data: { text: '' }
                                }]
                            });
                        }
                    } catch (contentError) {
                        console.error('Error loading post content:', contentError);
                        // Fallback to empty editor
                        try {
                            await editor.render({
                                blocks: [{
                                    type: 'paragraph',
                                    data: { text: 'Error loading content. Please refresh the page.' }
                                }]
                            });
                        } catch (fallbackError) {
                            console.error('Even fallback content failed:', fallbackError);
                        }
                    }

                    updateDocumentStatus('saved');
                    
                    // Update analytics safely
                    try {
                        if (typeof updateAnalytics === 'function') {
                            updateAnalytics();
                        }
                    } catch (analyticsError) {
                        console.warn('Analytics update failed:', analyticsError);
                    }
                    
                    showAutoSaveIndicator('saved');
                    showNotification('Post loaded successfully', 'success');
                    return; // Success, exit retry loop
                    
                } catch (error) {
                    loadAttempts++;
                    console.error(`Load attempt ${loadAttempts} failed:`, error);
                    
                    if (loadAttempts >= maxAttempts) {
                        // All attempts failed, try fallback strategies
                        if (error.message.includes('Post not found') || error.message.includes('404') || error.type === 'NOT_FOUND') {
                            console.log('Post not found, trying localStorage fallback');
                            
                            // Try to load from localStorage
                            try {
                                const localPost = loadFromLocalStorage(postId);
                                if (localPost) {
                                    console.log('Found post in localStorage, loading as fallback');
                                    // Recursively call loadPost with local data (but prevent infinite loop)
                                    await loadPostFromData(localPost, true);
                                    showNotification('Post loaded from local storage (may be outdated)', 'warning');
                                    return;
                                }
                            } catch (localError) {
                                console.error('localStorage fallback also failed:', localError);
                            }
                            
                            // No fallback available, create new post
                            console.log('No fallback available, creating new post');
                            showNotification('Post not found. Starting with a new post.', 'warning');
                            
                            const newUrl = window.location.pathname;
                            window.history.replaceState({}, '', newUrl);
                            currentPostId = null;
                            isNewPost = true;
                            
                            if (typeof setupNewPost === 'function') {
                                setupNewPost();
                            }
                            updateDocumentStatus('draft');
                            showAutoSaveIndicator('saved');
                            return;
                            
                        } else {
                            // Other errors
                            let errorMessage = 'Failed to load post';
                            if (error.userMessage) {
                                errorMessage = error.userMessage;
                            } else if (error.message.includes('Editor')) {
                                errorMessage = 'Editor initialization failed. Please refresh the page.';
                            } else if (error.message.includes('network') || error.message.includes('fetch')) {
                                errorMessage = 'Network error. Please check your connection and try again.';
                            }
                            
                            showNotification(errorMessage, 'error');
                            showAutoSaveIndicator('error');
                            
                            // Offer retry option
                            setTimeout(() => {
                                if (confirm('Would you like to try loading the post again?')) {
                                    loadPost(postId);
                                }
                            }, 3000);
                            return;
                        }
                    } else {
                        // Wait before retry
                        await new Promise(resolve => setTimeout(resolve, 1000 * loadAttempts));
                    }
                }
            }
        }

        // Helper function to safely set form values
        function safeSetValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
            } else {
                console.warn(`Element with ID '${elementId}' not found`);
            }
        }

        // Helper function to safely set checkbox values
        function safeSetChecked(elementId, checked) {
            const element = document.getElementById(elementId);
            if (element) {
                element.checked = checked;
            } else {
                console.warn(`Checkbox with ID '${elementId}' not found`);
            }
        }

        // Load post from localStorage
        function loadFromLocalStorage(postId) {
            try {
                const posts = JSON.parse(localStorage.getItem('likwid_blog_posts') || '[]');
                return posts.find(p => p.id == postId);
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        // Load post from data object (for fallback scenarios)
        async function loadPostFromData(post, isFromCache = false) {
            // This is a simplified version of loadPost that works with data objects
            // Implementation would be similar to loadPost but without the network call
            try {
                safeSetValue('post-title', post.title || '');
                safeSetValue('post-status', post.status || 'draft');
                safeSetValue('post-category', post.category || 'Technology');
                safeSetValue('post-excerpt', post.excerpt || '');
                
                if (post.content && editor) {
                    let editorData = typeof post.content === 'string' ? JSON.parse(post.content) : post.content;
                    await editor.render(editorData);
                }
                
                updateDocumentStatus(isFromCache ? 'cached' : 'saved');
                showAutoSaveIndicator(isFromCache ? 'offline' : 'saved');
                
            } catch (error) {
                console.error('Error loading post from data:', error);
                throw error;
            }
        }

        // Cover Image Functions
        function initializeCoverImageFeatures() {
            const coverContainer = document.querySelector('.cover-image-container');
            const generateBtn = document.getElementById('generate-cover-btn');
            const regenerateBtn = document.getElementById('regenerate-cover-btn');
            const uploadBtn = document.getElementById('upload-cover-btn');
            const removeBtn = document.getElementById('remove-cover-btn');
            const fileInput = document.createElement('input');
            
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            // Generate cover image
            generateBtn?.addEventListener('click', async () => {
                await generateCoverImage();
            });

            // Regenerate cover image
            regenerateBtn?.addEventListener('click', async () => {
                await regenerateCoverImage();
            });

            // Upload cover image
            uploadBtn?.addEventListener('click', () => {
                fileInput.click();
            });

            // Remove cover image
            removeBtn?.addEventListener('click', () => {
                removeCoverImage();
            });

            // Handle file selection
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleCoverImageUpload(file);
                }
            });

            // Click on placeholder to generate
            const placeholder = document.querySelector('.cover-image-placeholder');
            placeholder?.addEventListener('click', async () => {
                await generateCoverImage();
            });
        }

        async function generateCoverImage() {
            const title = document.getElementById('post-title').value;
            if (!title.trim()) {
                showToast('Please enter a title first to generate a cover image', 'warning');
                return;
            }

            const container = document.querySelector('.cover-image-container');
            container.classList.add('cover-image-generating');

            try {
                showToast('Generating cover image...', 'info');
                
                const response = await fetch('/api/ai/generate-cover-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate cover image');
                }

                const result = await response.json();
                displayCoverImage(result.imageUrl);
                showToast('Cover image generated successfully!', 'success');
                
                // Mark as unsaved
                hasUnsavedChanges = true;
                updateDocumentStatus('unsaved');
                
            } catch (error) {
                console.error('Error generating cover image:', error);
                showToast('Failed to generate cover image', 'error');
            } finally {
                container.classList.remove('cover-image-generating');
            }
        }

        async function regenerateCoverImage() {
            const title = document.getElementById('post-title').value;
            if (!title.trim()) {
                showToast('Please enter a title first', 'warning');
                return;
            }

            const container = document.querySelector('.cover-image-container');
            container.classList.add('cover-image-generating');

            try {
                showToast('Regenerating cover image...', 'info');
                
                const response = await fetch('/api/ai/regenerate-cover-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (!response.ok) {
                    throw new Error('Failed to regenerate cover image');
                }

                const result = await response.json();
                displayCoverImage(result.imageUrl);
                showToast('Cover image regenerated successfully!', 'success');
                
                // Mark as unsaved
                hasUnsavedChanges = true;
                updateDocumentStatus('unsaved');
                
            } catch (error) {
                console.error('Error regenerating cover image:', error);
                showToast('Failed to regenerate cover image', 'error');
            } finally {
                container.classList.remove('cover-image-generating');
            }
        }

        function handleCoverImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Please select a valid image file', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showToast('Image file too large. Please select an image under 5MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                displayCoverImage(e.target.result);
                hasUnsavedChanges = true;
                updateDocumentStatus('unsaved');
                showToast('Cover image uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function displayCoverImage(imageUrl) {
            const placeholder = document.querySelector('.cover-image-placeholder');
            const display = document.getElementById('cover-image-display');
            
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            if (display) {
                display.src = imageUrl;
                display.style.display = 'block';
            }
        }

        function removeCoverImage() {
            const placeholder = document.querySelector('.cover-image-placeholder');
            const display = document.getElementById('cover-image-display');
            
            if (display) {
                display.src = '';
                display.style.display = 'none';
            }
            
            if (placeholder) {
                placeholder.style.display = 'flex';
            }

            hasUnsavedChanges = true;
            updateDocumentStatus('unsaved');
            showToast('Cover image removed', 'info');
        }

        function getCoverImageData() {
            const display = document.getElementById('cover-image-display');
            return display && display.style.display !== 'none' ? display.src : null;
        }

        function setCoverImage(imageUrl) {
            if (imageUrl) {
                displayCoverImage(imageUrl);
            }
        }

        // Setup new post
        function setupNewPost() {
            document.getElementById('author-name').value = 'Admin';
            document.getElementById('author-title').value = 'Content Creator';
            document.getElementById('author-avatar').value = 'AD';
            updateDocumentStatus('draft');
        }

        // Generate complete content package from topic
        async function generatePostFromTopic(topic) {
            try {
                showAIThinking('🚀 Generating complete content package for: ' + topic);
                updateAIProgress('Analyzing your request...', 10);
                
                // Use the new complete content generation
                const completeContent = await aiService.generateCompleteContent(topic);
                
                updateAIProgress('Content generated! Populating editor...', 90);
                
                // Update all form fields with generated data
                const blogPost = completeContent.blogPost;
                
                document.getElementById('post-title').value = blogPost.title;
                document.getElementById('post-category').value = blogPost.category || 'Technology';
                document.getElementById('post-excerpt').value = blogPost.excerpt || '';
                document.getElementById('keywords').value = blogPost.keywords || '';
                document.getElementById('meta-title').value = blogPost.meta_title || '';
                document.getElementById('meta-description').value = blogPost.meta_description || '';
                document.getElementById('author-name').value = blogPost.author || 'Likwid.AI Team';
                
                // Set the featured image if generated
                if (completeContent.imageData && completeContent.imageData.url) {
                    document.getElementById('featured-image-url').value = completeContent.imageData.url;
                    document.getElementById('image-alt-text').value = completeContent.imageData.altText || '';
                    
                    // Update image preview
                    const preview = document.getElementById('image-preview');
                    if (preview) {
                        preview.src = completeContent.imageData.url;
                        preview.style.display = 'block';
                    }
                }
                
                // Render content in editor
                if (blogPost.content && blogPost.content.blocks) {
                    await editor.render(blogPost.content);
                } else {
                    // Fallback content structure
                    const fallbackContent = {
                        blocks: [
                            {
                                type: 'paragraph',
                                data: {
                                    text: `This is a comprehensive guide about ${topic}. Let's explore this topic in detail with insights from AI analysis.`
                                }
                            },
                            {
                                type: 'header',
                                data: {
                                    text: 'Introduction',
                                    level: 2
                                }
                            },
                            {
                                type: 'paragraph',
                                data: {
                                    text: `In this article, we'll dive deep into ${topic} and explore its various aspects, benefits, and implementation strategies for manufacturing operations.`
                                }
                            }
                        ]
                    };
                    await editor.render(fallbackContent);
                }
                
                // Update UI elements
                updateSlugFromTitle();
                updateCharacterCounters();
                hasUnsavedChanges = true;
                updateAnalytics();
                
                // Show generation insights
                if (completeContent.refinedBrief) {
                    showGenerationInsights(completeContent);
                }
                
                updateAIProgress('Complete! Content ready for editing.', 100);
                
                setTimeout(() => {
                    hideAIThinking();
                    showNotification(`🎉 Complete content package generated! Created ${completeContent.processingSteps.length} optimizations including keywords, SEO, and featured image.`, 'success');
                }, 1000);
                
            } catch (error) {
                hideAIThinking();
                console.error('Error generating complete content:', error);
                
                // Fallback to basic content generation
                try {
                    showAIThinking('Falling back to basic content generation...');
                    const basicPostData = await aiService.generateBlogPost(topic);
                    
                    document.getElementById('post-title').value = basicPostData.title || topic;
                    document.getElementById('post-category').value = basicPostData.category || 'Technology';
                    document.getElementById('post-excerpt').value = basicPostData.excerpt || '';
                    document.getElementById('keywords').value = basicPostData.keywords || '';
                    
                    if (basicPostData.content && basicPostData.content.blocks) {
                        await editor.render(basicPostData.content);
                    }
                    
                    updateSlugFromTitle();
                    updateCharacterCounters();
                    hasUnsavedChanges = true;
                    
                    hideAIThinking();
                    showNotification('Basic content generated successfully!', 'success');
                    
                } catch (fallbackError) {
                    hideAIThinking();
                    console.error('Fallback generation failed:', fallbackError);
                    
                    // Manual fallback
                    document.getElementById('post-title').value = topic;
                    updateSlugFromTitle();
                    
                    const content = {
                        blocks: [
                            {
                                type: 'paragraph',
                                data: {
                                    text: `This is a comprehensive guide about ${topic}. Let's explore this topic in detail.`
                                }
                            },
                            {
                                type: 'header',
                                data: {
                                    text: 'Introduction',
                                    level: 2
                                }
                            },
                            {
                                type: 'paragraph',
                                data: {
                                    text: `In this article, we'll dive deep into ${topic} and explore its various aspects, benefits, and implementation strategies.`
                                }
                            }
                        ]
                    };
                    
                    editor.render(content);
                    hasUnsavedChanges = true;
                    updateAnalytics();
                    
                    showNotification(`Generated basic structure for "${topic}". AI services may be temporarily unavailable - please refine the content manually.`, 'warning');
                }
            }
        }

        // Show generation insights modal
        function showGenerationInsights(completeContent) {
            const insights = completeContent.refinedBrief;
            const keywords = completeContent.keywordStrategy;
            const seo = completeContent.seoAnalysis;
            
            const modal = document.createElement('div');
            modal.className = 'ai-insights-modal';
            modal.innerHTML = `
                <div class="ai-insights-content">
                    <div class="ai-insights-header">
                        <h3>🧠 AI Content Generation Insights</h3>
                        <button onclick="this.closest('.ai-insights-modal').remove()" class="close-btn">×</button>
                    </div>
                    <div class="ai-insights-body">
                        <div class="insight-section">
                            <h4>📋 Content Strategy</h4>
                            <div class="insight-item">
                                <strong>Target Audience:</strong> ${insights.target_audience}
                            </div>
                            <div class="insight-item">
                                <strong>Content Angle:</strong> ${insights.content_angle}
                            </div>
                            <div class="insight-item">
                                <strong>Business Value:</strong> ${insights.business_value}
                            </div>
                        </div>
                        
                        <div class="insight-section">
                            <h4>🔑 Keyword Strategy</h4>
                            <div class="insight-item">
                                <strong>Primary Keywords:</strong> ${keywords.primary.slice(0, 5).join(', ')}
                            </div>
                            <div class="insight-item">
                                <strong>CSV Matches:</strong> ${keywords.csv_matches.length} relevant keywords found
                            </div>
                        </div>
                        
                        <div class="insight-section">
                            <h4>📊 SEO Analysis</h4>
                            <div class="insight-item">
                                <strong>SEO Score:</strong> ${seo.score}/100
                            </div>
                            <div class="insight-item">
                                <strong>Content Length:</strong> ${seo.details.contentWords} words
                            </div>
                        </div>
                        
                        <div class="insight-section">
                            <h4>✨ Generated Features</h4>
                            <div class="features-grid">
                                ${completeContent.processingSteps.map(step => 
                                    `<div class="feature-tag">✅ ${step}</div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="ai-insights-footer">
                        <button onclick="this.closest('.ai-insights-modal').remove()" class="btn-secondary">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 10000);
        }

        // Update AI progress indicator
        function updateAIProgress(message, percentage) {
            const statusEl = document.getElementById('ai-status');
            if (statusEl) {
                statusEl.innerHTML = `
                    <div class="ai-progress">
                        <div class="ai-progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="ai-progress-text">${message}</div>
                `;
                statusEl.className = 'ai-status show';
            }
        }

        // AI Content Generation Interface Functions
        function showAIGeneration() {
            const section = document.getElementById('ai-generation-section');
            section.style.display = 'block';
            document.getElementById('topic-input').focus();
        }

        function hideAIGeneration() {
            const section = document.getElementById('ai-generation-section');
            section.style.display = 'none';
        }

        function setTopicAndGenerate(topic) {
            document.getElementById('topic-input').value = topic;
            generateCompleteContent();
        }

        // Generate complete content with comprehensive error handling
        async function generateCompleteContent() {
            const topicInput = document.getElementById('topic-input');
            const topic = topicInput.value.trim();
            
            if (!topic) {
                showNotification('Please enter a topic to generate content about', 'warning');
                topicInput.focus();
                return;
            }

            if (topic.length < 10) {
                showNotification('Please provide a more detailed topic description (at least 10 characters)', 'warning');
                topicInput.focus();
                return;
            }

            // Check if AI service is available
            if (!window.aiService) {
                showNotification('AI service is not available. Please check your configuration.', 'error');
                return;
            }

            try {
                // Hide the generation interface and start the process
                hideAIGeneration();
                
                // Generate the complete content with error handling
                await generatePostFromTopic(topic);
                
                // Clear the input on success
                topicInput.value = '';
                
            } catch (error) {
                console.error('Complete content generation failed:', error);
                
                // Show the generation interface again
                showAIGeneration();
                
                // Provide specific error message
                let errorMessage = 'Failed to generate content';
                if (error.message.includes('AI service')) {
                    errorMessage = 'AI service is unavailable. Please check your API configuration.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
                
                // Offer basic content creation as fallback
                setTimeout(() => {
                    if (confirm('Would you like to create a basic post template instead?')) {
                        createBasicPostTemplate(topic);
                    }
                }, 2000);
            }
        }

        // Create basic post template as fallback
        function createBasicPostTemplate(topic) {
            try {
                // Set basic fields
                document.getElementById('post-title').value = topic;
                document.getElementById('post-category').value = 'Technology';
                document.getElementById('post-excerpt').value = `A comprehensive guide about ${topic}`;
                
                // Generate basic slug
                const slug = generateSlug(topic);
                document.getElementById('post-slug').value = slug;
                
                // Create basic content structure
                const basicContent = {
                    blocks: [
                        {
                            type: 'header',
                            data: {
                                text: topic,
                                level: 1
                            }
                        },
                        {
                            type: 'paragraph',
                            data: {
                                text: `This is a comprehensive guide about ${topic}. Let's explore this topic in detail.`
                            }
                        },
                        {
                            type: 'header',
                            data: {
                                text: 'Introduction',
                                level: 2
                            }
                        },
                        {
                            type: 'paragraph',
                            data: {
                                text: 'Start writing your introduction here...'
                            }
                        },
                        {
                            type: 'header',
                            data: {
                                text: 'Main Content',
                                level: 2
                            }
                        },
                        {
                            type: 'paragraph',
                            data: {
                                text: 'Add your main content here...'
                            }
                        },
                        {
                            type: 'header',
                            data: {
                                text: 'Conclusion',
                                level: 2
                            }
                        },
                        {
                            type: 'paragraph',
                            data: {
                                text: 'Summarize your key points here...'
                            }
                        }
                    ]
                };
                
                // Load content into editor
                if (editor && editor.render) {
                    editor.render(basicContent);
                    hasUnsavedChanges = true;
                    showNotification('Basic post template created!', 'success');
                } else {
                    throw new Error('Editor is not available');
                }
                
            } catch (error) {
                console.error('Failed to create basic template:', error);
                showNotification('Failed to create basic template. Please try again.', 'error');
            }
        }

        // Show AI generation interface for new posts
        function checkForNewPost() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            const generateTopic = urlParams.get('generate');
            
            // If it's a new post (no edit ID) and no generation topic, show AI interface
            if (!editId && !generateTopic) {
                // Check if the title is empty (indicating a truly new post)
                setTimeout(() => {
                    const title = document.getElementById('post-title').value;
                    if (!title.trim()) {
                        showAIGeneration();
                    }
                }, 500);
            }
        }

        // Update analytics
        function updateAnalytics() {
            // Get content
            editor.save().then(data => {
                const textContent = extractTextFromEditorJS(data);
                const title = document.getElementById('post-title').value;
                const allText = title + ' ' + textContent;
                
                // Create post data for SEO analysis
                const postData = {
                    title: title,
                    content: JSON.stringify(data),
                    meta_title: document.getElementById('meta-title').value,
                    meta_description: document.getElementById('meta-description').value,
                    keywords: document.getElementById('keywords').value,
                    slug: document.getElementById('post-slug').value,
                    alt_text: document.getElementById('alt-text').value
                };
                
                // Calculate metrics using AI service
                const wordCount = allText.split(/\s+/).filter(word => word.length > 0).length;
                const readabilityScore = aiService.calculateReadability(allText);
                const seoAnalysis = aiService.calculateSEOScore(postData);
                const csvKeywordAnalysis = aiService.countCSVKeywords(allText);
                const keywordAnalytics = aiService.getKeywordAnalytics(allText);
                
                // Calculate keyword density
                const keywords = document.getElementById('keywords').value;
                const keywordList = keywords.split(',').map(k => k.trim()).filter(k => k.length > 0);
                let keywordDensity = 0;
                if (keywordList.length > 0) {
                    const totalKeywordOccurrences = keywordList.reduce((count, keyword) => {
                        const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                        return count + (allText.match(regex) || []).length;
                    }, 0);
                    keywordDensity = ((totalKeywordOccurrences / wordCount) * 100).toFixed(1);
                }
                
                // Update UI
                document.getElementById('live-word-count').textContent = wordCount;
                document.getElementById('word-count').textContent = `${wordCount} words`;
                document.getElementById('live-readability').textContent = readabilityScore;
                document.getElementById('csv-keywords-count').textContent = `${csvKeywordAnalysis.count}/${aiService.keywords.length}`;
                document.getElementById('keyword-density').textContent = `${keywordDensity}%`;
                
                // Update keyword coverage percentage
                const keywordCoverageElement = document.getElementById('keyword-coverage');
                if (keywordCoverageElement) {
                    keywordCoverageElement.textContent = `${csvKeywordAnalysis.percentage}%`;
                }
                
                // Update keyword suggestions
                updateKeywordSuggestions(keywordAnalytics.suggestions);
                
                // Update used keywords display
                updateUsedKeywordsDisplay(keywordAnalytics.usedKeywords);
                
                // Update SEO score circle
                const seoCircle = document.getElementById('seo-score-circle');
                seoCircle.textContent = seoAnalysis.score;
                seoCircle.className = `seo-score-circle ${seoAnalysis.score >= 80 ? 'score-excellent' : seoAnalysis.score >= 60 ? 'score-good' : 'score-poor'}`;
                
                // Update SEO factors
                const factorsList = document.getElementById('seo-factors-list');
                factorsList.innerHTML = seoAnalysis.factors.map(factor => {
                    const className = factor.startsWith('✓') ? 'good' : factor.startsWith('✗') ? 'error' : 'warning';
                    return `<div class="seo-factor ${className}">${factor}</div>`;
                }).join('');
                
            }).catch(console.error);
        }

        // Extract text from EditorJS data
        function extractTextFromEditorJS(data) {
            return data.blocks.map(block => {
                switch (block.type) {
                    case 'paragraph':
                    case 'header':
                        return block.data.text || '';
                    case 'list':
                        return block.data.items ? block.data.items.join(' ') : '';
                    case 'quote':
                        return block.data.text || '';
                    default:
                        return '';
                }
            }).join(' ');
        }

        // Calculate readability score (simplified)
        function calculateReadabilityScore(text) {
            const sentences = text.split(/[.!?]+/).length;
            const words = text.split(/\s+/).length;
            const avgWordsPerSentence = words / sentences;
            
            let score = 100;
            if (avgWordsPerSentence > 20) score -= 20;
            if (avgWordsPerSentence > 30) score -= 20;
            
            return Math.max(0, Math.round(score));
        }

        // Calculate SEO score
        function calculateSEOScore() {
            let score = 0;
            
            const title = document.getElementById('post-title').value;
            const metaTitle = document.getElementById('meta-title').value;
            const metaDesc = document.getElementById('meta-description').value;
            const keywords = document.getElementById('keywords').value;
            
            // Title length
            if (title.length >= 30 && title.length <= 60) score += 25;
            
            // Meta title
            if (metaTitle.length >= 30 && metaTitle.length <= 60) score += 25;
            
            // Meta description
            if (metaDesc.length >= 120 && metaDesc.length <= 160) score += 25;
            
            // Keywords
            if (keywords.length > 0) score += 25;
            
            return score;
        }

        // Save post to backend with comprehensive error handling
        async function savePost(status = 'draft', isAutoSave = false) {
            try {
                showAutoSaveIndicator('saving');
                
                // Validate editor state
                if (!editor) {
                    throw new Error('Editor is not initialized');
                }
                
                // Get editor data with error handling
                let editorData;
                try {
                    editorData = await editor.save();
                } catch (editorError) {
                    console.error('Editor save error:', editorError);
                    throw new Error('Failed to save editor content. Please try again.');
                }
                
                // Validate required fields
                const title = document.getElementById('post-title').value.trim();
                if (!title && !isAutoSave) {
                    throw new Error('Post title is required');
                }
                
                const postData = {
                    id: currentPostId || null,
                    title: title || 'Untitled',
                    content: editorData, // Store as object, backend will handle JSON
                    status: status,
                    category: document.getElementById('post-category').value,
                    excerpt: document.getElementById('post-excerpt').value,
                    featuredImage: document.getElementById('featured-image').value,
                    coverImage: getCoverImageData(), // Add cover image
                    is_featured: document.getElementById('is-featured').checked ? 1 : 0,
                    author: document.getElementById('author-name').value || 'Admin',
                    author_title: document.getElementById('author-title').value || 'Content Creator',
                    author_avatar: document.getElementById('author-avatar').value || 'AD',
                    slug: document.getElementById('post-slug').value || generateSlug(title || 'untitled'),
                    meta_title: document.getElementById('meta-title').value,
                    meta_description: document.getElementById('meta-description').value,
                    keywords: document.getElementById('keywords').value,
                    imageAlt: document.getElementById('alt-text').value,
                    readTime: estimateReadTime(editorData),
                    canonical_url: '', // Can be set later
                    seo_score: calculateSEOScore()
                };
                
                console.log('Saving post to backend:', postData);
                
                // Initialize PostStorageService if not available
                if (!window.postStorage) {
                    window.postStorage = new PostStorageService();
                }
                
                // Try to save to backend with retry logic
                let savedPost;
                let saveAttempts = 0;
                const maxAttempts = isAutoSave ? 1 : 3;
                
                while (saveAttempts < maxAttempts) {
                    try {
                        savedPost = await window.postStorage.savePost(postData);
                        break; // Success, exit retry loop
                    } catch (saveError) {
                        saveAttempts++;
                        console.error(`Save attempt ${saveAttempts} failed:`, saveError);
                        
                        if (saveAttempts >= maxAttempts) {
                            // Final attempt failed, try localStorage fallback
                            if (isAutoSave) {
                                // For auto-save, silently save to localStorage
                                saveToLocalStorage(postData);
                                showAutoSaveIndicator('offline');
                                return false;
                            } else {
                                // For manual save, offer fallback option
                                const useOffline = confirm(
                                    'Unable to save to server. Would you like to save locally to prevent data loss?'
                                );
                                if (useOffline) {
                                    saveToLocalStorage(postData);
                                    showNotification('Post saved locally. Will sync when server is available.', 'warning');
                                    showAutoSaveIndicator('offline');
                                    return true;
                                } else {
                                    throw saveError;
                                }
                            }
                        } else if (!isAutoSave) {
                            // Wait before retry (only for manual saves)
                            await new Promise(resolve => setTimeout(resolve, 1000 * saveAttempts));
                        }
                    }
                }
                
                // Update current post ID if this was a new post
                if (!currentPostId && savedPost && savedPost.id) {
                    currentPostId = savedPost.id;
                    
                    // Update URL with post ID
                    const newUrl = window.location.pathname + '?edit=' + savedPost.id;
                    window.history.replaceState({}, '', newUrl);
                }
                
                console.log('Post saved to backend:', savedPost);
                
                hasUnsavedChanges = false;
                updateDocumentStatus(status);
                showAutoSaveIndicator('saved');
                
                if (!isAutoSave) {
                    const isNew = !currentPostId;
                    showNotification(
                        isNew ? 'Post created successfully!' : 'Post updated successfully!', 
                        'success'
                    );
                }
                
                return true;
                
            } catch (error) {
                console.error('Save error:', error);
                
                // Handle different error types
                let errorMessage = 'Failed to save post';
                if (error.message.includes('Editor')) {
                    errorMessage = 'Editor error: ' + error.message;
                } else if (error.message.includes('required')) {
                    errorMessage = error.message;
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.userMessage) {
                    errorMessage = error.userMessage;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                if (!isAutoSave) {
                    showNotification(errorMessage, 'error');
                }
                
                showAutoSaveIndicator('error');
                return false;
            }
        }

        // Save to localStorage as fallback
        function saveToLocalStorage(postData) {
            try {
                const posts = JSON.parse(localStorage.getItem('likwid_blog_posts') || '[]');
                const existingIndex = posts.findIndex(p => p.id === postData.id);
                
                if (existingIndex >= 0) {
                    posts[existingIndex] = { ...posts[existingIndex], ...postData, updated: new Date().toISOString() };
                } else {
                    const tempId = postData.id || Date.now();
                    posts.push({ ...postData, id: tempId, created: new Date().toISOString(), updated: new Date().toISOString() });
                    if (!currentPostId) {
                        currentPostId = tempId;
                    }
                }
                
                localStorage.setItem('likwid_blog_posts', JSON.stringify(posts));
                console.log('Post saved to localStorage as fallback');
                
            } catch (localError) {
                console.error('Failed to save to localStorage:', localError);
                throw new Error('Unable to save post anywhere. Please try again.');
            }
        }

        // Publish post
        async function publishPost() {
            if (await savePost('published')) {
                showNotification('Post published successfully!', 'success');
                window.location.href = 'blog-dashboard.html';
            }
        }

        // Helper function to generate URL slug from title
        function generateSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^a-z0-9 -]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        // Helper function to estimate read time
        function estimateReadTime(editorData) {
            let wordCount = 0;
            
            if (editorData.blocks) {
                editorData.blocks.forEach(block => {
                    if (block.data && block.data.text) {
                        wordCount += block.data.text.split(/\s+/).length;
                    }
                    if (block.data && block.data.items) {
                        block.data.items.forEach(item => {
                            wordCount += item.split(/\s+/).length;
                        });
                    }
                });
            }
            
            // Average reading speed is 200-250 words per minute
            return Math.max(1, Math.ceil(wordCount / 225));
        }

        // Preview post
        function previewPost() {
            savePost('draft').then(() => {
                window.open(`blog-preview.html?id=${currentPostId}`, '_blank');
            });
        }

        // Generate SEO fields with AI
        // Generate SEO fields with AI and comprehensive error handling
        async function generateSEOFields() {
            try {
                const title = document.getElementById('post-title').value.trim();
                if (!title) {
                    showNotification('Please enter a title first', 'warning');
                    document.getElementById('post-title').focus();
                    return;
                }
                
                // Check if AI service is available
                if (!window.aiService) {
                    throw new Error('AI service is not available. Please check your configuration.');
                }
                
                showAIThinking('Generating SEO fields...');
                
                // Get editor content with error handling
                let content, textContent;
                try {
                    content = await editor.save();
                    textContent = extractTextFromEditorJS(content);
                } catch (editorError) {
                    console.warn('Could not get editor content, using title only:', editorError);
                    textContent = title; // Fallback to title only
                }
                
                // Generate SEO data with retry logic
                let seoData;
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts) {
                    try {
                        seoData = await aiService.generateSEO(title, textContent);
                        break; // Success, exit retry loop
                    } catch (aiError) {
                        attempts++;
                        console.error(`SEO generation attempt ${attempts} failed:`, aiError);
                        
                        if (attempts >= maxAttempts) {
                            // All attempts failed, use fallback
                            console.log('Using fallback SEO generation');
                            seoData = generateFallbackSEO(title, textContent);
                            showNotification('AI SEO generation failed, using basic SEO fields', 'warning');
                            break;
                        } else {
                            // Wait before retry
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempts));
                        }
                    }
                }
                
                // Apply SEO data with validation
                if (seoData) {
                    safeSetValue('meta-title', seoData.meta_title || title);
                    safeSetValue('meta-description', seoData.meta_description || generateFallbackDescription(title));
                    safeSetValue('keywords', seoData.keywords || generateFallbackKeywords(title));
                    safeSetValue('alt-text', seoData.alt_text || `Image for ${title}`);
                    safeSetValue('post-slug', seoData.slug || generateSlug(title));
                    
                    // Update counters safely
                    try {
                        if (typeof updateCharacterCounters === 'function') {
                            updateCharacterCounters();
                        }
                    } catch (counterError) {
                        console.warn('Character counter update failed:', counterError);
                    }
                    
                    hasUnsavedChanges = true;
                    
                    // Update analytics safely
                    try {
                        if (typeof updateAnalytics === 'function') {
                            updateAnalytics();
                        }
                    } catch (analyticsError) {
                        console.warn('Analytics update failed:', analyticsError);
                    }
                    
                    hideAIThinking();
                    showNotification('SEO fields generated successfully!', 'success');
                } else {
                    throw new Error('No SEO data generated');
                }
                
            } catch (error) {
                hideAIThinking();
                console.error('SEO generation error:', error);
                
                // Provide specific error messages
                let errorMessage = 'Failed to generate SEO fields';
                if (error.message.includes('AI service')) {
                    errorMessage = 'AI service is unavailable. Please check your API configuration.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
                
                // Offer manual fallback
                setTimeout(() => {
                    if (confirm('Would you like to generate basic SEO fields instead?')) {
                        generateBasicSEO();
                    }
                }, 2000);
            }
        }

        // Generate fallback SEO data when AI fails
        function generateFallbackSEO(title, content) {
            return {
                meta_title: title.length > 60 ? title.substring(0, 57) + '...' : title,
                meta_description: generateFallbackDescription(title, content),
                keywords: generateFallbackKeywords(title, content),
                alt_text: `Image for ${title}`,
                slug: generateSlug(title)
            };
        }

        // Generate fallback description
        function generateFallbackDescription(title, content = '') {
            const maxLength = 155;
            let description = `Learn about ${title}`;
            
            if (content && content.length > 50) {
                // Extract first meaningful sentence from content
                const sentences = content.split(/[.!?]+/);
                const firstSentence = sentences[0]?.trim();
                if (firstSentence && firstSentence.length > 20) {
                    description = firstSentence;
                }
            }
            
            return description.length > maxLength ? description.substring(0, maxLength - 3) + '...' : description;
        }

        // Generate fallback keywords
        function generateFallbackKeywords(title, content = '') {
            const words = (title + ' ' + content).toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 3);
            
            // Get unique words and take first 5
            const uniqueWords = [...new Set(words)].slice(0, 5);
            return uniqueWords.join(', ');
        }

        // Generate basic SEO fields without AI
        function generateBasicSEO() {
            try {
                const title = document.getElementById('post-title').value.trim();
                if (!title) return;
                
                const basicSEO = generateFallbackSEO(title, '');
                
                safeSetValue('meta-title', basicSEO.meta_title);
                safeSetValue('meta-description', basicSEO.meta_description);
                safeSetValue('keywords', basicSEO.keywords);
                safeSetValue('alt-text', basicSEO.alt_text);
                safeSetValue('post-slug', basicSEO.slug);
                
                hasUnsavedChanges = true;
                showNotification('Basic SEO fields generated', 'success');
                
            } catch (error) {
                console.error('Basic SEO generation failed:', error);
                showNotification('Failed to generate basic SEO fields', 'error');
            }
        }

        // Get keyword suggestions
        async function getKeywordSuggestions() {
            try {
                const title = document.getElementById('post-title').value;
                const content = await editor.save();
                const textContent = extractTextFromEditorJS(content);
                const allText = title + ' ' + textContent;
                
                const suggestions = aiService.getKeywordSuggestions(allText, 15);
                
                const suggestionsContainer = document.getElementById('keyword-suggestions');
                const suggestionsList = document.getElementById('keyword-suggestions-list');
                
                suggestionsList.innerHTML = suggestions.map(keyword => 
                    `<span class="keyword-tag" onclick="addKeyword('${keyword}')">${keyword}</span>`
                ).join('');
                
                suggestionsContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error getting keyword suggestions:', error);
                alert('Failed to get keyword suggestions');
            }
        }

        // Add keyword to the keywords field
        function addKeyword(keyword) {
            const keywordsField = document.getElementById('keywords');
            const currentKeywords = keywordsField.value;
            
            if (currentKeywords) {
                keywordsField.value = currentKeywords + ', ' + keyword;
            } else {
                keywordsField.value = keyword;
            }
            
            hasUnsavedChanges = true;
            updateAnalytics();
            updateCharacterCounters();
            
            // Visual feedback
            event.target.classList.add('selected');
            setTimeout(() => {
                event.target.style.display = 'none';
            }, 300);
        }

        // AI Content Optimizer
        async function optimizeContent() {
            try {
                showAIThinking('Optimizing content...');
                
                const content = await editor.save();
                const currentKeywords = document.getElementById('keywords').value.split(',').map(k => k.trim());
                const suggestions = aiService.getKeywordSuggestions(
                    extractTextFromEditorJS(content),
                    5
                );
                
                const targetKeywords = [...currentKeywords, ...suggestions.slice(0, 3)];
                
                const improvedContent = await aiService.autoImproveContent(content.blocks, targetKeywords);
                
                if (improvedContent && improvedContent.length > 0) {
                    await editor.render({ blocks: improvedContent });
                    hasUnsavedChanges = true;
                    updateAnalytics();
                    hideAIThinking();
                    showNotification('Content optimized successfully!', 'success');
                } else {
                    hideAIThinking();
                    showNotification('Content is already well optimized!', 'info');
                }
                
            } catch (error) {
                hideAIThinking();
                console.error('Content optimization error:', error);
                alert('Failed to optimize content: ' + error.message);
            }
        }

        // Ask AI for help
        async function askAI() {
            try {
                const query = document.getElementById('ai-query').value;
                if (!query) {
                    alert('Please enter a question or request');
                    return;
                }
                
                showAIThinking('AI is thinking...');
                
                const content = await editor.save();
                const textContent = extractTextFromEditorJS(content);
                
                const prompt = `
                Blog post context:
                Title: "${document.getElementById('post-title').value}"
                Content: "${textContent.substring(0, 1000)}..."
                
                User question: "${query}"
                
                Provide a helpful, specific response for improving this blog post. Be concise and actionable.
                `;
                
                const response = await aiService.generateContent(prompt, 300);
                
                document.getElementById('ai-response-text').textContent = response;
                document.getElementById('ai-response').style.display = 'block';
                document.getElementById('ai-query').value = '';
                
                hideAIThinking();
                
            } catch (error) {
                hideAIThinking();
                console.error('AI query error:', error);
                alert('Failed to get AI response: ' + error.message);
            }
        }

        // Apply AI suggestion (placeholder for now)
        function applyAISuggestion() {
            showNotification('AI suggestions can be manually applied to your content', 'info');
            document.getElementById('ai-response').style.display = 'none';
        }

        // Get content ideas
        async function getContentIdeas() {
            try {
                showAIThinking('Generating content ideas...');
                
                const ideas = await aiService.generateContentIdeas();
                
                let ideasHTML = '<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">Content Ideas:</div>';
                ideas.slice(0, 3).forEach(idea => {
                    ideasHTML += `
                        <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--notion-bg-tertiary); border-radius: 4px; font-size: 0.875rem;">
                            <div style="font-weight: 500;">${idea.title}</div>
                            <div style="font-size: 0.75rem; color: var(--notion-text-light);">${idea.description}</div>
                        </div>
                    `;
                });
                
                document.getElementById('ai-response-text').innerHTML = ideasHTML;
                document.getElementById('ai-response').style.display = 'block';
                
                hideAIThinking();
                
            } catch (error) {
                hideAIThinking();
                console.error('Content ideas error:', error);
                alert('Failed to generate content ideas: ' + error.message);
            }
        }

        // Show AI thinking indicator
        function showAIThinking(message = 'AI is working...') {
            const indicator = document.createElement('div');
            indicator.id = 'ai-thinking-indicator';
            indicator.className = 'ai-thinking';
            indicator.innerHTML = `<i class="fas fa-robot"></i> <span>${message}</span>`;
            indicator.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                background: white;
                padding: 0.75rem 1rem;
                border-radius: 6px;
                box-shadow: var(--shadow-medium);
                border: 1px solid var(--notion-border);
                z-index: 1001;
            `;
            document.body.appendChild(indicator);
        }

        // Hide AI thinking indicator
        function hideAIThinking() {
            const indicator = document.getElementById('ai-thinking-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Get AI improvements
        async function getAIImprovements() {
            try {
                showAIThinking('Analyzing content for improvements...');
                
                const postData = {
                    title: document.getElementById('post-title').value,
                    content: JSON.stringify(await editor.save()),
                    meta_title: document.getElementById('meta-title').value,
                    meta_description: document.getElementById('meta-description').value,
                    keywords: document.getElementById('keywords').value,
                    slug: document.getElementById('post-slug').value,
                    alt_text: document.getElementById('alt-text').value
                };
                
                const improvements = await aiService.generateImprovements(postData);
                
                const improvementsContainer = document.getElementById('ai-improvements');
                const improvementsList = document.getElementById('ai-improvements-list');
                
                improvementsList.innerHTML = improvements.suggestions.map(suggestion => `
                    <div class="improvement-suggestion priority-${suggestion.priority}">
                        <div style="font-weight: 600; color: var(--notion-text); margin-bottom: 0.25rem;">
                            ${suggestion.type.toUpperCase()} • ${suggestion.priority.toUpperCase()} PRIORITY
                        </div>
                        <div style="margin-bottom: 0.5rem;">${suggestion.suggestion}</div>
                        <div style="font-size: 0.75rem; color: var(--notion-text-light);">${suggestion.reason}</div>
                    </div>
                `).join('');
                
                improvementsContainer.style.display = 'block';
                
                hideAIThinking();
                
            } catch (error) {
                hideAIThinking();
                console.error('Error getting AI improvements:', error);
                alert('Failed to get AI improvements: ' + error.message);
            }
        }

        // Update the calculateSEOScore function to use AI service
        function calculateSEOScore() {
            // This is now handled in updateAnalytics() using aiService
            return 0;
        }

        // Update character counters
        function updateCharacterCounters() {
            // Excerpt counter
            const excerptField = document.getElementById('post-excerpt');
            const excerptCounter = document.getElementById('excerpt-counter');
            const excerptLength = excerptField.value.length;
            excerptCounter.textContent = `${excerptLength}/160`;
            excerptCounter.className = `char-counter ${excerptLength > 160 ? 'over-limit' : ''}`;

            // Meta title counter
            const metaTitleField = document.getElementById('meta-title');
            const metaTitleCounter = document.getElementById('meta-title-counter');
            const metaTitleLength = metaTitleField.value.length;
            metaTitleCounter.textContent = `${metaTitleLength}/60`;
            metaTitleCounter.className = `char-counter ${metaTitleLength > 60 ? 'over-limit' : ''}`;

            // Meta description counter
            const metaDescField = document.getElementById('meta-description');
            const metaDescCounter = document.getElementById('meta-desc-counter');
            const metaDescLength = metaDescField.value.length;
            metaDescCounter.textContent = `${metaDescLength}/160`;
            metaDescCounter.className = `char-counter ${metaDescLength > 160 ? 'over-limit' : ''}`;
        }

        // Update document status
        function updateDocumentStatus(status) {
            const statusElement = document.getElementById('document-status');
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            switch (status) {
                case 'saving':
                    statusElement.textContent = 'Saving...';
                    break;
                case 'saved':
                    statusElement.textContent = `Draft • Saved at ${timeString}`;
                    break;
                case 'published':
                    statusElement.textContent = `Published • ${timeString}`;
                    break;
                case 'unsaved':
                    statusElement.textContent = 'Draft • Unsaved changes';
                    break;
                default:
                    statusElement.textContent = 'Draft • Auto-saved';
            }
        }

        // Show auto-save indicator
        function showAutoSaveIndicator(status) {
            const indicator = document.getElementById('auto-save-indicator');
            const text = indicator.querySelector('span');
            
            indicator.className = `auto-save-indicator show ${status}`;
            
            if (status === 'saving') {
                text.textContent = 'Saving...';
            } else if (status === 'saved') {
                text.textContent = 'Saved';
            }
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Start auto-save with error handling and recovery
        function startAutoSave() {
            let autoSaveFailures = 0;
            const maxFailures = 3;
            
            autoSaveInterval = setInterval(async () => {
                if (hasUnsavedChanges) {
                    try {
                        const success = await savePost('draft', true); // isAutoSave = true
                        if (success) {
                            autoSaveFailures = 0; // Reset failure count on success
                        } else {
                            autoSaveFailures++;
                        }
                    } catch (error) {
                        autoSaveFailures++;
                        console.error(`Auto-save failed (attempt ${autoSaveFailures}):`, error);
                    }
                    
                    // If too many failures, show warning and reduce frequency
                    if (autoSaveFailures >= maxFailures) {
                        showNotification(
                            'Auto-save has failed multiple times. Please save manually to prevent data loss.', 
                            'warning', 
                            10000
                        );
                        
                        // Reduce auto-save frequency to avoid spam
                        stopAutoSave();
                        setTimeout(() => {
                            if (hasUnsavedChanges) {
                                startAutoSave();
                                autoSaveFailures = 0; // Reset for new interval
                            }
                        }, 120000); // Wait 2 minutes before trying again
                    }
                }
            }, 30000); // Auto-save every 30 seconds
            
            console.log('Auto-save started (every 30 seconds)');
        }

        // Stop auto-save
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
                console.log('Auto-save stopped');
            }
        }

        // Enhanced auto-save indicator with more states
        function showAutoSaveIndicator(status) {
            const indicator = document.getElementById('auto-save-indicator');
            const text = indicator.querySelector('span');
            
            // Remove all status classes
            indicator.classList.remove('saving', 'saved', 'error', 'offline', 'loading');
            
            switch (status) {
                case 'saving':
                    indicator.classList.add('saving');
                    text.textContent = 'Saving...';
                    break;
                case 'saved':
                    indicator.classList.add('saved');
                    text.textContent = 'Saved';
                    break;
                case 'error':
                    indicator.classList.add('error');
                    text.textContent = 'Save failed';
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    text.textContent = 'Saved offline';
                    break;
                case 'loading':
                    indicator.classList.add('loading');
                    text.textContent = 'Loading...';
                    break;
                default:
                    text.textContent = 'Auto-save';
            }
        }

        // Prevent data loss on page unload
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                const message = 'You have unsaved changes. Are you sure you want to leave?';
                e.returnValue = message;
                return message;
            }
        });

        // Handle visibility change to pause/resume auto-save
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, save immediately if there are changes
                if (hasUnsavedChanges) {
                    savePost('draft', true);
                }
            } else {
                // Page is visible again, resume auto-save if needed
                if (!autoSaveInterval && hasUnsavedChanges) {
                    startAutoSave();
                }
            }
        });

        // Update last edited time
        setInterval(() => {
            const lastEdited = document.getElementById('last-edited');
            lastEdited.textContent = 'Last edited just now';
        }, 60000);

        // Enhanced keyword tracking functions
        function updateKeywordSuggestions(suggestions) {
            const container = document.getElementById('keyword-suggestions');
            if (!container || !suggestions || suggestions.length === 0) {
                if (container) container.innerHTML = '<span class="keyword-tag">No suggestions</span>';
                return;
            }

            container.innerHTML = suggestions.slice(0, 10).map(suggestion => 
                `<span class="keyword-tag suggested clickable" onclick="addKeywordToContent('${suggestion.keyword}')" title="Relevance: ${(suggestion.relevance * 100).toFixed(0)}%">${suggestion.keyword}</span>`
            ).join('');
        }

        function updateUsedKeywordsDisplay(usedKeywords) {
            const container = document.getElementById('used-keywords-display');
            const countElement = document.getElementById('used-keywords-count');
            
            if (!container) return;

            if (!usedKeywords || usedKeywords.length === 0) {
                container.innerHTML = '<span class="keyword-tag">No keywords used yet</span>';
                if (countElement) countElement.textContent = '0';
                return;
            }

            // Update count
            if (countElement) countElement.textContent = usedKeywords.length;

            // Display used keywords sorted by count
            container.innerHTML = usedKeywords
                .sort((a, b) => b.count - a.count)
                .slice(0, 15)
                .map(keyword => 
                    `<span class="keyword-tag used" title="Used ${keyword.count} times (${keyword.density}% density)">${keyword.keyword}</span>`
                ).join('');
        }

        function addKeywordToContent(keyword) {
            if (!editor) return;

            // Add keyword to the end of current content
            editor.save().then(data => {
                const newBlock = {
                    type: 'paragraph',
                    data: {
                        text: `Consider integrating the concept of "${keyword}" into your content strategy.`
                    }
                };
                
                // Insert the block
                editor.blocks.insert(newBlock.type, newBlock.data);
                
                // Update analytics
                setTimeout(updateAnalytics, 500);
                
                // Show feedback
                showTemporaryMessage(`Added keyword suggestion: "${keyword}"`);
            });
        }

        function showTemporaryMessage(message) {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                bottom: 120px;
                right: 20px;
                background: var(--notion-green);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.875rem;
                z-index: 1002;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            indicator.textContent = message;
            document.body.appendChild(indicator);
            
            // Fade in
            setTimeout(() => indicator.style.opacity = '1', 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => document.body.removeChild(indicator), 300);
            }, 3000);
        }

        // Enhanced analytics tracking
        function trackKeywordPerformance() {
            if (!aiService || !aiService.keywords) return;

            const performanceData = {
                timestamp: new Date().toISOString(),
                totalKeywords: aiService.keywords.length,
                session: {
                    startTime: window.sessionStartTime || new Date().toISOString(),
                    keywordsAdded: window.sessionKeywordsAdded || 0,
                    contentLength: 0
                }
            };

            // Save to localStorage for tracking
            const trackingKey = 'likwid_keyword_performance';
            let tracking = JSON.parse(localStorage.getItem(trackingKey) || '[]');
            tracking.push(performanceData);
            
            // Keep only last 50 entries
            if (tracking.length > 50) {
                tracking = tracking.slice(-50);
            }
            
            localStorage.setItem(trackingKey, JSON.stringify(tracking));
        }

        // Initialize session tracking
        if (!window.sessionStartTime) {
            window.sessionStartTime = new Date().toISOString();
            window.sessionKeywordsAdded = 0;
        }

        // Track performance every 5 minutes
        setInterval(trackKeywordPerformance, 5 * 60 * 1000);

        // ==================== IMAGE MANAGEMENT FUNCTIONS ====================

        // Current image state
        let currentImageBlob = null;
        let currentImageData = null;

        // Switch between image tabs
        function switchImageTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.image-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide tab content
            document.querySelectorAll('.image-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tabName + '-tab').style.display = 'block';
        }

        // Remove current image
        function removeCurrentImage() {
            document.getElementById('current-image-display').style.display = 'none';
            document.getElementById('featured-image').value = '';
            currentImageBlob = null;
            currentImageData = null;
        }

        // Auto-generate image based on post title
        async function autoGenerateImage() {
            const title = document.getElementById('post-title').value;
            if (!title.trim()) {
                showNotification('Please enter a post title first', 'warning');
                return;
            }

            const prompt = `Professional blog header image for article titled "${title}". Modern, clean design suitable for manufacturing/ERP industry blog. High quality, business appropriate.`;
            document.getElementById('image-prompt').value = prompt;
            await generateImage();
        }

        // Generate image using AI
        async function generateImage() {
            const prompt = document.getElementById('image-prompt').value;
            if (!prompt.trim()) {
                showNotification('Please enter an image description', 'warning');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            const autoGenerateBtn = document.getElementById('auto-generate-btn');
            const loadingDiv = document.getElementById('image-loading');
            const resultDiv = document.getElementById('image-result');

            try {
                // Show loading state
                generateBtn.disabled = true;
                autoGenerateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                loadingDiv.style.display = 'block';
                resultDiv.style.display = 'none';

                console.log('Generating image with prompt:', prompt);

                // Generate image using AI service
                const result = await window.aiService.generateImage(prompt);

                // Display result
                document.getElementById('generated-image-preview').src = result.imageUrl;
                document.getElementById('image-description').textContent = result.description || 'AI-generated image';
                
                // Store the result data
                currentImageBlob = result.blob;
                currentImageData = result;

                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                showNotification('Image generated successfully!', 'success');

            } catch (error) {
                console.error('Image generation error:', error);
                showNotification(`Image generation failed: ${error.message}`, 'error');
                loadingDiv.style.display = 'none';
                resultDiv.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
                autoGenerateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Image';
            }
        }

        // Regenerate image with same prompt
        async function regenerateImage() {
            await generateImage();
        }

        // Use the generated image
        function useGeneratedImage() {
            if (!currentImageData) {
                showNotification('No image to use', 'warning');
                return;
            }

            // Set the image URL
            document.getElementById('featured-image').value = currentImageData.imageUrl;
            
            // Show current image display
            document.getElementById('current-image-preview').src = currentImageData.imageUrl;
            document.getElementById('current-image-display').style.display = 'block';
            
            // Hide result
            document.getElementById('image-result').style.display = 'none';

            showNotification('Image set as featured image!', 'success');
        }

        // Setup file upload functionality
        function setupFileUpload() {
            const fileInput = document.getElementById('image-file-input');
            const uploadArea = document.getElementById('file-upload-area');
            const uploadBtn = document.getElementById('upload-btn');

            // Click to select file
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Handle file selection
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFileSelection(file);
                }
            });

            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        handleFileSelection(file);
                    } else {
                        showNotification('Please select an image file', 'warning');
                    }
                }
            });
        }

        // Handle file selection
        function handleFileSelection(file) {
            const uploadBtn = document.getElementById('upload-btn');
            const uploadArea = document.getElementById('file-upload-area');
            
            uploadArea.querySelector('p').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            uploadBtn.disabled = false;
            
            // Store the file for upload
            uploadArea.selectedFile = file;
        }

        // Upload and analyze image
        async function uploadImage() {
            const uploadArea = document.getElementById('file-upload-area');
            const file = uploadArea.selectedFile;
            
            if (!file) {
                showNotification('Please select a file first', 'warning');
                return;
            }

            const uploadBtn = document.getElementById('upload-btn');
            const loadingDiv = document.getElementById('image-loading');

            try {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                loadingDiv.style.display = 'block';

                console.log('Uploading and analyzing image:', file.name);

                // Analyze the image
                const analysis = await window.aiService.analyzeImage(file, "Describe this image and suggest an appropriate alt text for a manufacturing/ERP blog");

                // Create blob URL for preview
                const imageUrl = URL.createObjectURL(file);
                
                // Set the image
                document.getElementById('featured-image').value = imageUrl;
                document.getElementById('current-image-preview').src = imageUrl;
                document.getElementById('current-image-display').style.display = 'block';

                loadingDiv.style.display = 'none';
                showNotification(`Image uploaded successfully! Analysis: ${analysis.substring(0, 100)}...`, 'success');

                // Reset upload area
                uploadArea.querySelector('p').textContent = 'Drop an image here or click to browse';
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload & Analyze';
                uploadArea.selectedFile = null;

            } catch (error) {
                console.error('Image upload error:', error);
                showNotification(`Image upload failed: ${error.message}`, 'error');
                loadingDiv.style.display = 'none';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload & Analyze';
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                color: white;
                padding: 1rem;
                border-radius: 6px;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Initialize image management when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();

            // Check if featured image URL changes
            const featuredImageInput = document.getElementById('featured-image');
            featuredImageInput.addEventListener('input', function() {
                const url = this.value.trim();
                if (url && (url.startsWith('http') || url.startsWith('blob:'))) {
                    document.getElementById('current-image-preview').src = url;
                    document.getElementById('current-image-display').style.display = 'block';
                } else {
                    document.getElementById('current-image-display').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
